#!/bin/rc -e
argv0=$0

fn die {
	echo $argv0: '<error>' $* >[1=2]
	exit 1
}

fn msg {
	echo $argv0: '<message>' $*
}

root=`{mount | awk '/\/mnt/ { print $1 }'}
boot=`{echo $root | sed 's/[0-9]*$//g'}
if (test -z $boot) die no device found at /mnt

message installing limine...
limine-install $boot
cp /usr/share/limine/limine.sys /mnt/boot

message setting bootloader...
version=`{ls /lib/modules | tail -n1} # XXX
cat <<EOF >/mnt/boot/limine.cfg
TIMEOUT 5

:Eltanin Glacies
PROTOCOL=linux
KERNEL_PATH=boot:///vmlinuz-$version
CMDLINE=root=$root rootfstype=ext4 quiet
MODULE_PATH=boot:///initramfs-$version
EOF
