#!/bin/rc -e

argv0=$0

fn usage {
	printf 'usage: %s [version]\n' $argv0 >[1=2]
	exit 1
}

fn sigexit {
	rm -Rf $"tmpdir
}

fn fhbuild @{
	cd $"1
	mkdir -p etc/default bin dev lib/firmware run sys proc
	ln -s . usr
	ln -s bin sbin
}

fn filesbuild @{
	cd $"1
	touch etc/fstab
	files=`{venus -l files ccore ecore kmod mdevd rc ubase | tr ' ' '\n' | egrep -v 'man[0-9]|include'}
	for (f in $files) cp -f /$f $f
}

fn modbuild @{
	cd $"1
	find /lib/modules/$"kversion/kernel/crypto             \
	    /lib/modules/$"kversion/kernel/fs                  \
	    /lib/modules/$"kversion/kernel/lib                 \
	    /lib/modules/$"kversion/kernel/drivers/block       \
	    /lib/modules/$"kversion/kernel/drivers/ata         \
	    /lib/modules/$"kversion/kernel/drivers/md          \
	    /lib/modules/$"kversion/kernel/drivers/firewire    \
	    /lib/modules/$"kversion/kernel/drivers/usb/host    \
	    /lib/modules/$"kversion/kernel/drivers/usb/storage \
	    /lib/modules/$"kversion/kernel/drivers/scsi        \
	    -type f >[2]/dev/null | cpio -dp .
	cp /lib/modules/$"kversion/modules.builtin lib/modules/$"kversion
	cp /lib/modules/$"kversion/modules.order lib/modules/$"kversion
	depmod -b . $"kversion
}

fn initbuild @{
	cd $"1
	install -m 0755 /etc/init.in $"tmpdir/init
	find . | cpio -H newc -o | pigz -9
}

if (test $#* -gt 1) usage
kversion=$"1
if (~ $"kversion) kversion=`{uname -r}

if (! test -d /lib/modules/$"kversion) {
	printf '%s: <error> no module directory named %s\n' \
	    $argv0 $"kversion >[1=2]
	exit 1
}

tmpdir=`{mktemp -d}
fhbuild    $tmpdir
filesbuild $tmpdir
modbuild   $tmpdir
initbuild  $tmpdir > /boot/initramfs-$"kversion
